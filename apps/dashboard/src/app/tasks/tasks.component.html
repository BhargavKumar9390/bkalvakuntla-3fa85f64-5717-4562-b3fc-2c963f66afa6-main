<div class="tasks-page">
  <div *ngIf="isLoading" class="loading-overlay">
    <mat-progress-spinner
      diameter="60"
      mode="indeterminate"
    ></mat-progress-spinner>
  </div>

  <div class="tasks-container">
    <div class="page-header">
      <h2 class="page-title">Tasks</h2>
      <button
        type="button"
        class="help-button"
        (click)="showShortcuts = !showShortcuts"
        title="Keyboard shortcuts"
      >
        <mat-icon>help_outline</mat-icon>
      </button>
    </div>

    <!-- Shortcuts Help Panel -->
    <div
      *ngIf="showShortcuts"
      class="shortcuts-panel"
      role="dialog"
      aria-label="Keyboard shortcuts"
    >
      <div class="shortcuts-header">
        <h3>Keyboard Shortcuts</h3>
        <button
          type="button"
          class="close-help"
          (click)="showShortcuts = false"
          aria-label="Close shortcuts"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <ul class="shortcuts-list">
        <li><span class="key">n</span> <span class="action">New task</span></li>
        <li>
          <span class="key">e</span>
          <span class="action">Edit selected task</span>
        </li>
        <li>
          <span class="key">Delete / Backspace</span>
          <span class="action">Delete selected task</span>
        </li>
        <li>
          <span class="key">Space</span>
          <span class="action">Toggle completion</span>
        </li>
        <li>
          <span class="key">/</span> <span class="action">Focus search</span>
        </li>
        <li>
          <span class="key">s</span> <span class="action">Save modal</span>
        </li>
        <li>
          <span class="key">↑ / ↓</span>
          <span class="action">Navigate tasks</span>
        </li>
      </ul>
    </div>

    <!-- Filters and Search Section -->
    <div class="filters-section">
      <div class="search-row">
        <mat-form-field class="search-field" appearance="outline">
          <mat-icon matPrefix class="search-icon">search</mat-icon>
          <input
            #searchInput
            matInput
            [(ngModel)]="newTitle"
            (ngModelChange)="onSearchChange($event)"
            placeholder="Search tasks"
            autocomplete="off"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="status-field">
          <mat-select
            [(ngModel)]="filterStatus"
            (selectionChange)="load()"
            placeholder="All Status"
          >
            <mat-option value="">All Status</mat-option>
            <mat-option value="TODO">To Do</mat-option>
            <mat-option value="IN_PROGRESS">In Progress</mat-option>
            <mat-option value="DONE">Done</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="controls-row">
        <div class="filter-controls">
          <div class="filter-group">
            <mat-form-field appearance="outline" class="mat-filter-field">
              <mat-label>Category</mat-label>
              <mat-select
                [(ngModel)]="filterCategory"
                (selectionChange)="load()"
              >
                <mat-option value="">All</mat-option>
                <mat-option value="WORK">Work</mat-option>
                <mat-option value="PERSONAL">Personal</mat-option>
                <mat-option value="URGENT">Urgent</mat-option>
                <mat-option value="OTHER">Other</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="filter-group sort">
            <mat-form-field appearance="outline" class="mat-filter-field short">
              <mat-label>Sort</mat-label>
              <mat-select [(ngModel)]="sortField" (selectionChange)="load()">
                <mat-option value="dueDate">Due Date</mat-option>
                <mat-option value="priority">Priority</mat-option>
                <mat-option value="title">Title</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field
              appearance="outline"
              class="mat-filter-field short order-by"
            >
              <mat-label>Order by</mat-label>
              <mat-select [(ngModel)]="sortOrder" (selectionChange)="load()">
                <mat-option value="asc">Ascending</mat-option>
                <mat-option value="desc">Descending</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <div>
          <div class="right-controls">
            <button
              *ngIf="hasActiveFilters"
              mat-stroked-button
              class="clear-filters-main"
              (click)="clearFilters()"
            >
              Clear Filters
            </button>

            <button
              *hasPermission="'CREATE_TASK'"
              mat-flat-button
              color="primary"
              (click)="create()"
              [disabled]="isLoading"
              class="create-button"
            >
              Create Task
            </button>

            <div
              *ngIf="!auth.hasPermission('CREATE_TASK')"
              class="permission-hint"
              title="You need CREATE_TASK permission to create new tasks"
            >
              <svg
                class="w-4 h-4 text-gray-400 inline mr-1"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m0 0v2m0-2h2m-2 0H10m-7-7a9 9 0 1118 0 9 9 0 01-18 0z"
                />
              </svg>
              <span class="text-xs text-gray-500">View-only mode</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tasks List -->
    <ng-container *ngIf="!isLoading">
      <div *ngIf="tasks.length === 0" class="empty-state">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="empty-icon"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M9 12h6m-3-3v6m2 6H7a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v7a2 2 0 01-2 2z"
          />
        </svg>
        <ng-container *ngIf="hasActiveFilters; else noTasks">
          <h3 class="empty-title">No results found</h3>
          <p class="empty-description">
            No tasks match your current filters. Try adjusting your search
            criteria.
          </p>
          <button
            mat-stroked-button
            (click)="clearFilters()"
            class="action-button"
          >
            Clear Filters
          </button>
        </ng-container>
        <ng-template #noTasks>
          <h3 class="empty-title">No tasks yet</h3>
          <p class="empty-description">
            Get started by creating your first task to stay organized.
          </p>
          <div class="empty-actions">
            <button
              *hasPermission="'CREATE_TASK'"
              mat-flat-button
              color="primary"
              (click)="create()"
              class="create-button"
            >
              Create Task
            </button>
          </div>
        </ng-template>
      </div>

      <ul *ngIf="tasks.length > 0" id="task-list" class="tasks-list">
        <li
          *ngFor="let t of tasks; let i = index"
          class="task-item"
          [class.selected]="selectedIndex === i"
          [class.drop-target]="hoverIndex === i"
          [attr.draggable]="auth.hasPermission('UPDATE_TASK') ? 'true' : null"
          (dragstart)="
            auth.hasPermission('UPDATE_TASK') && onDragStart($event, i)
          "
          (dragenter)="
            auth.hasPermission('UPDATE_TASK') && onDragEnter($event, i)
          "
          (dragleave)="
            auth.hasPermission('UPDATE_TASK') && onDragLeave($event, i)
          "
          (dragover)="
            auth.hasPermission('UPDATE_TASK') && onDragOver($event, i)
          "
          (drop)="auth.hasPermission('UPDATE_TASK') && onDrop($event, i)"
        >
          <div class="task-content">
            <div class="drag-handle" title="Drag to reorder" aria-hidden="true">
              ⋮⋮
            </div>
            <app-task-card
              [task]="t"
              (edit)="edit($event)"
              (delete)="remove($event)"
              (toggleComplete)="onToggleComplete($event)"
            ></app-task-card>
          </div>
          <div
            *ngIf="hoverIndex === i"
            class="drop-indicator"
            aria-hidden="true"
          ></div>
        </li>
      </ul>

      <app-task-modal
        *ngIf="showModal"
        [initial]="editing"
        [saving]="saving"
        (saved)="onModalSave($event)"
        (closed)="onModalClose()"
      ></app-task-modal>
    </ng-container>
  </div>
</div>
